var mindRegex = /^\s*```\s{0,4}mind((.*[\r\n]+)+?)?\s*```$/im;
var mindTplBegin = '<div class=\"mind\" style="width: 100%;overflow-x:auto;margin-left:{i}px"><canvas id="canvas"></canvas><div class="mindTxt" style="display:none">';
var mindTplEnd = '</div></div>\n';

function processmindMapBlockList(page) {
  var match;

  while ((match = mindRegex.exec(page.content))) {
    var rawBlock = match[0];
    var mindMapContent = match[1];
    var indent = rawBlock.indexOf("`");
    page.content = page.content.replace(rawBlock, (indent > 0 ? mindTplBegin.replace("{i}", parseInt(indent/4) * 40) : mindTplBegin) + mindMapContent + mindTplEnd);
  }

  return page;
}

module.exports = {
  book: {
        assets: './assets',
        js: [
            'mindMap.js',
            'plugin.js'
        ]
  },
  hooks: {
    'page:before': processmindMapBlockList,
    'page:change': processmindMapBlockList
  }
};
